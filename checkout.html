<!DOCTYPE html><html lang="pt"><head>
<meta charset="UTF-8">


<!--[if gt IE 9]><!-->
<script defer="" type="text/javascript" src="js/main.js"></script>
<!--<![endif]-->

<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Checkout - Dados de Envio | Loja Cacau Show</title>

<meta name="description" content="Checkout - Dados de Envio - Loja Cacau Show">
<meta name="keywords" content="Checkout, Envio, Entrega, Cacau Show">

<meta property="og:title" content="Checkout - Dados de Envio | Loja Cacau Show">
<meta property="og:description" content="Checkout - Dados de Envio - Loja Cacau Show">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Cacau Show">
<meta property="og:locale" content="pt_BR">

<link rel="icon" href="images/favicon.ico" sizes="32x32">
<link rel="icon" href="images/favicon.svg" type="image/svg+xml">


<link rel="stylesheet" href="css/global.css">
<link rel="stylesheet" href="css/detail.css">
<link rel="stylesheet" href="css/backgroundColorLayout.css">
<link rel="stylesheet" href="css/component.css">
<link rel="stylesheet" href="css/productTile.css">
<link rel="stylesheet" href="css/einsteinCarousel.css">
<link rel="stylesheet" href="css/campaignBanner.css">
<link rel="stylesheet" href="css/smartOrderRefill.css">

<style>
/* Cor de fundo uniforme para todas as páginas */
body {
    background-color: #E7E0D8 !important;
    min-height: 100vh;
}

.checkout-form {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.checkout-form h2 {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #00A859;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.form-group label .required {
    color: #dc3545;
    margin-left: 3px;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s;
    box-sizing: border-box;
    line-height: 1.5;
    height: auto;
    min-height: auto;
}

/* Garante que select tenha exatamente a mesma altura dos inputs */
select.form-control {
    height: auto !important;
    min-height: auto !important;
    line-height: 1.5 !important;
    padding-top: 12px !important;
    padding-bottom: 12px !important;
}

.form-control:focus {
    outline: none;
    border-color: #00A859;
    box-shadow: 0 0 0 3px rgba(0, 168, 89, 0.1);
}

.form-control.error {
    border-color: #dc3545;
}

/* Corrige o corte de texto no select de estado e garante mesma altura dos outros campos */
select.form-control,
select#estado,
#estado.form-control {
    padding: 12px 40px 12px 15px !important;
    text-indent: 0 !important;
    text-overflow: clip !important;
    overflow: visible !important;
    white-space: nowrap !important;
    word-wrap: normal !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 15px center !important;
    background-size: 12px !important;
    cursor: pointer !important;
    min-width: 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
    line-height: 1.5 !important;
    height: auto !important;
    min-height: auto !important;
    direction: ltr !important;
    text-align: left !important;
    font-size: 14px !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
}

select.form-control option {
    padding: 8px 12px;
    white-space: normal;
}

/* Garante que o texto do select não seja cortado - regra específica e forte */
#estado {
    padding: 12px 40px 12px 15px !important;
    text-indent: 0 !important;
    text-overflow: clip !important;
    overflow: visible !important;
    white-space: nowrap !important;
    direction: ltr !important;
    text-align: left !important;
    height: auto !important;
    min-height: auto !important;
    line-height: 1.5 !important;
}

.cep-search-btn {
    margin-top: 8px;
    padding: 8px 16px;
    background: #0066CC;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
}

.cep-search-btn:hover {
    background: #0052a3;
}

.cep-loading {
    display: none;
    color: #0066CC;
    font-size: 12px;
    margin-top: 5px;
}

.row-form {
    display: flex;
    gap: 15px;
}

.row-form .form-group {
    flex: 1;
}

.btn-checkout {
    width: 100%;
    background: #00A859;
    color: white;
    border: none;
    padding: 16px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
}

.btn-checkout:hover {
    background: #008a47;
}

.btn-checkout:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.btn-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #0066CC;
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 20px;
}

.btn-back:hover {
    text-decoration: underline;
}

/* Regras específicas e fortes para evitar corte de texto no select de estado */
select#estado,
#estado,
select[name="estado"],
.form-group select#estado {
    padding-left: 20px !important;
    padding-right: 45px !important;
    padding-top: 12px !important;
    padding-bottom: 12px !important;
    text-indent: 0 !important;
    text-overflow: clip !important;
    overflow: visible !important;
    white-space: nowrap !important;
    word-wrap: normal !important;
    direction: ltr !important;
    text-align: left !important;
    box-sizing: border-box !important;
    width: 100% !important;
    min-width: 100px !important;
    max-width: 100% !important;
}

/* Força o padding interno do select */
select#estado::-ms-expand {
    display: none;
}

select#estado option {
    padding: 10px 15px !important;
    text-indent: 0 !important;
}

/* Ajustar posicionamento da imagem "feliz hoje" para não cobrir os ícones sociais */
.footer__image {
    margin-top: 5px !important;
}

.footer__image img {
    position: relative;
    top: 3px;
}
</style>

<link rel="stylesheet" href="css/skin.css">

</head><body>


<div class="page" data-action="null" data-querystring="null">
<header class="it__header">
    <a href="#maincontent" class="skip" aria-label="Ir para conteúdo principal">Ir para conteúdo principal</a>
    <a href="#footercontent" class="skip" aria-label="Ir para conteúdo do rodapé">Ir para conteúdo do rodapé</a>
    <div class="header-banner slide-up d-none">
        <div class="container">
            <div class="d-flex justify-content-between">
                <div class="content"></div>
                <div class="close-button">
                    <button type="button" class="close" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="header container">
        <div class="it__header--bgContainer">
            <div class="it__header--bg container-wrapper">
                <div class="col p-0">
                    <div class="navbar-header brand">
                        <div class="d-flex flex-row justify-content-between align-items-center">
                            <a class="logo-home" href="index.html" title="Cacau Show Home">
                                <img class="it_header--logo" src="images/logo_cacau_show.svg" alt="Cacau Show">
                            </a>
                            <div class="d-xl-none d-flex align-items-center">
                                <div class="minicart" data-action-url="/on/demandware.store/Sites-CacauShow-Site/pt_BR/Cart-MiniCartShow">
                                    <div class="minicart-total">
                                        <a class="minicart-link" href="carrinho.html" title="carrinho 0 Itens" aria-label="carrinho 0 Itens" aria-haspopup="true">
                                            <i class="minicart-icon fa fa-shopping-bag"></i>
                                            <span class="minicart-quantity">0</span>
                                        </a>
                                    </div>
                                    <div class="popover popover-bottom"></div>
                                </div>
                                <button class="navbar-toggler" type="button" aria-controls="sg-navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                                    <span class="icon-menu"></span>
                                </button>
                                <button class="close-button" type="button" role="button" aria-label="Fechar menu">
                                    Fechar menu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-5">
                    <div class="it__search">
                        <div class="site-search">
                            <form role="search" action="/busca" method="get" name="simpleSearch">
                                <input class="form-control search-field" type="text" name="q" value="" placeholder="Buscar Produto" role="combobox" aria-describedby="search-assistive-text" aria-haspopup="listbox" aria-owns="search-results" aria-expanded="false" aria-autocomplete="list" aria-activedescendant="" aria-controls="search-results" aria-label="Insira palavra chave ou nº do item" autocomplete="off">
                                <button type="reset" name="reset-button" class="reset-button d-none" aria-label="">
                                    <img src="images/icon-x-lg.svg" alt="">
                                </button>
                                <div class="suggestions-wrapper" data-url="/on/demandware.store/Sites-CacauShow-Site/pt_BR/SearchServices-GetSuggestions?q="></div>
                                <input type="hidden" value="null" name="lang">
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-xl-5 it__login">
                    <div class="it__login--options">
                        <div class="user">
                            <a class="btn btn-chamoisee" href="/minha-conta" role="button" aria-label="Entrar na minha conta">
                                <i class="fa fa-sign-in" aria-hidden="true"></i>
                                <span class="user-message">Entrar</span>
                            </a>
                        </div>
                        <div class="it__changeCep">
                            <button class="js-header-postal-code" data-toggle="modal" data-target="#modal-cep">
                                <span class="it__changeCep__address">Cacau Show - SP</span>
                                <span class="it__changeCep__btnChange">Alterar</span>
                            </button>
                        </div>
                    </div>
                    <div class="it__minicart d-none d-xl-block">
                        <div class="minicart" data-action-url="/on/demandware.store/Sites-CacauShow-Site/pt_BR/Cart-MiniCartShow">
                            <div class="minicart-total">
                                <a class="minicart-link" href="carrinho.html" title="carrinho 0 Itens" aria-label="carrinho 0 Itens" aria-haspopup="true">
                                    <i class="minicart-icon fa fa-shopping-bag"></i>
                                    <span class="minicart-quantity">0</span>
                                </a>
                            </div>
                            <div class="popover popover-bottom"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<div role="main" class="null" id="maincontent">
    <div class="storepage" id="checkout">
        <div class="container" style="padding: 40px 15px;">
            <div class="row">
                <div class="col-12">
                    <div class="it_product-detail__name" style="margin-bottom: 40px; padding-top: 20px;">
                        <h1 style="font-size: 28px; font-weight: 600; color: #333; margin: 0;">Dados de Envio</h1>
                    </div>
                    
                    <a href="carrinho.html" class="btn-back">
                        <i class="fa fa-arrow-left"></i>
                        Voltar ao Carrinho
                    </a>

                    <div class="row">
                        <div class="col-lg-8 col-12">
                            <form id="checkout-form" class="checkout-form">
                                <h2>Dados Pessoais</h2>
                                
                                <div class="form-group">
                                    <label for="nome">Nome Completo <span class="required">*</span></label>
                                    <input type="text" id="nome" name="nome" class="form-control" required placeholder="Digite seu nome completo">
                                </div>

                                <div class="row-form">
                                    <div class="form-group">
                                        <label for="email">E-mail <span class="required">*</span></label>
                                        <input type="email" id="email" name="email" class="form-control" required placeholder="seu@email.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="cpf">CPF <span class="required">*</span></label>
                                        <input type="text" id="cpf" name="cpf" class="form-control" required placeholder="000.000.000-00" maxlength="14">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="telefone">Telefone <span class="required">*</span></label>
                                    <input type="tel" id="telefone" name="telefone" class="form-control" required placeholder="(11) 99999-9999" maxlength="15">
                                </div>

                                <h2 style="margin-top: 40px;">Endereço de Entrega</h2>

                                <div class="form-group">
                                    <label for="cep">CEP <span class="required">*</span></label>
                                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                                        <input type="text" id="cep" name="cep" class="form-control" required placeholder="00000-000" maxlength="9" style="flex: 1;">
                                        <button type="button" id="btn-buscar-cep" class="cep-search-btn">
                                            <i class="fa fa-search"></i> Buscar
                                        </button>
                                    </div>
                                    <div id="cep-loading" class="cep-loading">
                                        <i class="fa fa-spinner fa-spin"></i> Buscando endereço...
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="rua">Rua/Logradouro <span class="required">*</span></label>
                                    <input type="text" id="rua" name="rua" class="form-control" required placeholder="Nome da rua">
                                </div>

                                <div class="row-form">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="numero">Número <span class="required">*</span></label>
                                        <input type="text" id="numero" name="numero" class="form-control" required placeholder="123">
                                    </div>
                                    <div class="form-group" style="flex: 3;">
                                        <label for="complemento">Complemento</label>
                                        <input type="text" id="complemento" name="complemento" class="form-control" placeholder="Apto, Bloco, etc.">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="bairro">Bairro <span class="required">*</span></label>
                                    <input type="text" id="bairro" name="bairro" class="form-control" required placeholder="Nome do bairro">
                                </div>

                                <div class="row-form">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="cidade">Cidade <span class="required">*</span></label>
                                        <input type="text" id="cidade" name="cidade" class="form-control" required placeholder="Nome da cidade">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="estado">Estado <span class="required">*</span></label>
                                        <select id="estado" name="estado" class="form-control" required>
                                            <option value="">Selecione</option>
                                            <option value="AC">Acre</option>
                                            <option value="AL">Alagoas</option>
                                            <option value="AP">Amapá</option>
                                            <option value="AM">Amazonas</option>
                                            <option value="BA">Bahia</option>
                                            <option value="CE">Ceará</option>
                                            <option value="DF">Distrito Federal</option>
                                            <option value="ES">Espírito Santo</option>
                                            <option value="GO">Goiás</option>
                                            <option value="MA">Maranhão</option>
                                            <option value="MT">Mato Grosso</option>
                                            <option value="MS">Mato Grosso do Sul</option>
                                            <option value="MG">Minas Gerais</option>
                                            <option value="PA">Pará</option>
                                            <option value="PB">Paraíba</option>
                                            <option value="PR">Paraná</option>
                                            <option value="PE">Pernambuco</option>
                                            <option value="PI">Piauí</option>
                                            <option value="RJ">Rio de Janeiro</option>
                                            <option value="RN">Rio Grande do Norte</option>
                                            <option value="RS">Rio Grande do Sul</option>
                                            <option value="RO">Rondônia</option>
                                            <option value="RR">Roraima</option>
                                            <option value="SC">Santa Catarina</option>
                                            <option value="SP">São Paulo</option>
                                            <option value="SE">Sergipe</option>
                                            <option value="TO">Tocantins</option>
                                        </select>
                                    </div>
                                </div>

                                <button type="submit" class="btn-checkout" id="btn-finalizar">
                                    <i class="fa fa-check"></i>
                                    Finalizar Pedido
                                </button>
                            </form>
                        </div>

                        <div class="col-lg-4 col-12">
                            <div style="position: sticky; top: 20px;">
                                <div style="background: #f8f8f8; padding: 30px; border-radius: 8px; border: 1px solid #e8e8e8;">
                                    <h2 style="font-size: 20px; font-weight: 600; color: #333; margin: 0 0 25px 0; padding-bottom: 15px; border-bottom: 1px solid #ddd;">Resumo do Pedido</h2>
                                    
                                    <div id="checkout-summary">
                                        <p style="color: #666; text-align: center; padding: 20px;">Carregando...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para formatar CEP
function formatCEP(value) {
    value = value.replace(/\D/g, '');
    if (value.length > 5) {
        value = value.substring(0, 5) + '-' + value.substring(5, 8);
    }
    return value;
}

// Função para formatar telefone
function formatTelefone(value) {
    value = value.replace(/\D/g, '');
    if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    } else {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    return value;
}

// Função para formatar CPF
function formatCPF(value) {
    value = value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }
    return value;
}

// Aplicar máscaras
document.getElementById('cep').addEventListener('input', function(e) {
    e.target.value = formatCEP(e.target.value);
});

document.getElementById('telefone').addEventListener('input', function(e) {
    e.target.value = formatTelefone(e.target.value);
});

document.getElementById('cpf').addEventListener('input', function(e) {
    e.target.value = formatCPF(e.target.value);
});

// Função para carregar localização salva
function carregarLocalizacaoSalva() {
    var enderecoSalvo = localStorage.getItem('cacaushow_endereco');
    if (enderecoSalvo) {
        try {
            var endereco = JSON.parse(enderecoSalvo);
            
            // Atualizar header
            var addressSpan = document.querySelector('.it__changeCep__address');
            if (addressSpan && endereco.estado) {
                addressSpan.textContent = 'Cacau Show - ' + endereco.estado;
            }
            
            // Preencher campos do checkout se existirem
            if (document.getElementById('cep') && endereco.cep) {
                var cepFormatado = endereco.cep.replace(/(\d{5})(\d{3})/, '$1-$2');
                document.getElementById('cep').value = cepFormatado;
            }
            
            if (document.getElementById('cidade') && endereco.cidade) {
                document.getElementById('cidade').value = endereco.cidade;
            }
            
            if (document.getElementById('estado') && endereco.estado) {
                document.getElementById('estado').value = endereco.estado;
            }
            
            if (document.getElementById('numero') && endereco.numero) {
                document.getElementById('numero').value = endereco.numero;
            }
            
            // Se tiver CEP, buscar automaticamente para preencher outros campos
            if (endereco.cep && document.getElementById('cep')) {
                setTimeout(function() {
                    buscarCEP();
                }, 500);
            }
        } catch (e) {
            console.error('Erro ao carregar localização salva:', e);
        }
    }
}

// Função para buscar CEP usando ViaCEP API
function buscarCEP() {
    var cep = document.getElementById('cep').value.replace(/\D/g, '');
    var loadingDiv = document.getElementById('cep-loading');
    var btnBuscar = document.getElementById('btn-buscar-cep');
    
    if (cep.length !== 8) {
        alert('Por favor, digite um CEP válido com 8 dígitos.');
        return;
    }
    
    loadingDiv.style.display = 'block';
    btnBuscar.disabled = true;
    
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            btnBuscar.disabled = false;
            
            if (data.erro) {
                alert('CEP não encontrado. Por favor, verifique e tente novamente.');
                return;
            }
            
            // Preencher campos automaticamente
            document.getElementById('rua').value = data.logradouro || '';
            document.getElementById('bairro').value = data.bairro || '';
            document.getElementById('cidade').value = data.localidade || '';
            document.getElementById('estado').value = data.uf || '';
            
            // Focar no campo número após preencher
            document.getElementById('numero').focus();
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            btnBuscar.disabled = false;
            alert('Erro ao buscar CEP. Por favor, tente novamente.');
            console.error('Erro:', error);
        });
}

// Event listeners
document.getElementById('btn-buscar-cep').addEventListener('click', buscarCEP);

document.getElementById('cep').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        buscarCEP();
    }
});

// Carregar localização salva ao carregar a página
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', carregarLocalizacaoSalva);
} else {
    carregarLocalizacaoSalva();
}

// Carregar resumo do carrinho
function loadCartSummary() {
    var cart = JSON.parse(localStorage.getItem('cacaushow_cart') || '[]');
    var summaryDiv = document.getElementById('checkout-summary');
    var total = 0;
    
    if (cart.length === 0) {
        summaryDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Seu carrinho está vazio</p>';
        return;
    }
    
    var html = '<div style="margin-bottom: 20px;">';
    cart.forEach(function(item) {
        var itemTotal = item.price * item.quantity;
        total += itemTotal;
        html += '<div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0;">';
        html += '<div style="flex: 1;">';
        html += '<p style="margin: 0; font-size: 14px; color: #333; font-weight: 500;">' + item.name + '</p>';
        html += '<p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Qtd: ' + item.quantity + '</p>';
        html += '</div>';
        html += '<div style="text-align: right;">';
        html += '<p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">R$ ' + itemTotal.toFixed(2).replace('.', ',') + '</p>';
        html += '</div>';
        html += '</div>';
    });
    html += '</div>';
    
    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
    html += '<span style="font-size: 18px; font-weight: 600; color: #333;">Total:</span>';
    html += '<span style="font-size: 24px; font-weight: bold; color: #00A859;">R$ ' + total.toFixed(2).replace('.', ',') + '</span>';
    html += '</div>';
    html += '</div>';
    
    summaryDiv.innerHTML = html;
}

// Atualizar badge do carrinho
function updateCartBadge() {
    var cart = JSON.parse(localStorage.getItem('cacaushow_cart') || '[]');
    var total = cart.reduce(function(sum, item) { return sum + item.quantity; }, 0);
    var badges = document.querySelectorAll('.minicart-quantity');
    badges.forEach(function(badge) {
        badge.textContent = total;
    });
}

// Carregar resumo ao carregar a página
loadCartSummary();
updateCartBadge();

// Função para validar CPF
function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11) return false;
    
    // Verifica se todos os dígitos são iguais
    if (/^(\d)\1{10}$/.test(cpf)) return false;
    
    // Validação dos dígitos verificadores
    var soma = 0;
    var resto;
    
    for (var i = 1; i <= 9; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    
    soma = 0;
    for (var i = 1; i <= 10; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;
    
    return true;
}

// Configuração do Supabase - Credenciais serão carregadas dinamicamente
// URL base do Supabase (pode ser pública)
var SUPABASE_BASE_URL = 'https://xudfilvyvydckranlipn.supabase.co';

// Variáveis globais para credenciais (serão carregadas da Edge Function)
var SUPABASE_URL = null;
var SUPABASE_KEY = null;
var DUTTYFY_PIX_URL_ENCRIPTADA = null;

// Função para carregar credenciais do Supabase de forma segura
function carregarCredenciais() {
    return new Promise(function(resolve, reject) {
        // Verificar se já temos credenciais em cache (sessionStorage)
        var credenciaisCache = sessionStorage.getItem('app_credentials');
        if (credenciaisCache) {
            try {
                var credenciais = JSON.parse(credenciaisCache);
                SUPABASE_URL = credenciais.supabaseUrl;
                SUPABASE_KEY = credenciais.supabaseAnonKey;
                DUTTYFY_PIX_URL_ENCRIPTADA = credenciais.pixApiUrl;
                console.log('Credenciais carregadas do cache');
                resolve(credenciais);
                return;
            } catch (e) {
                console.warn('Erro ao parsear cache de credenciais:', e);
            }
        }
        
        // Buscar credenciais da Edge Function do Supabase
        fetch(SUPABASE_BASE_URL + '/functions/v1/get-credentials', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Erro ao buscar credenciais: ' + response.status);
            }
            return response.json();
        })
        .then(function(credenciais) {
            // Armazenar credenciais nas variáveis globais
            SUPABASE_URL = credenciais.supabaseUrl;
            SUPABASE_KEY = credenciais.supabaseAnonKey;
            DUTTYFY_PIX_URL_ENCRIPTADA = credenciais.pixApiUrl;
            
            // Cachear credenciais na sessão (válido por 1 hora)
            sessionStorage.setItem('app_credentials', JSON.stringify(credenciais));
            sessionStorage.setItem('app_credentials_timestamp', Date.now().toString());
            
            console.log('Credenciais carregadas com sucesso da Edge Function');
            resolve(credenciais);
        })
        .catch(function(error) {
            console.error('Erro ao carregar credenciais:', error);
            // Fallback para valores padrão caso a função não esteja disponível
            SUPABASE_URL = 'https://xudfilvyvydckranlipn.supabase.co';
            SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1ZGZpbHZ5dnlkY2tyYW5saXBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODY4MDAsImV4cCI6MjA4NjE2MjgwMH0.jDevQSnfm25VYoT3jAIjKRLaxJDlQboGT_rNJoPT9v4';
            DUTTYFY_PIX_URL_ENCRIPTADA = 'https://www.pagamentos-seguros.app/api-pix/ObVzUOhxlLh4Mxcn3bWF6gRwM5r96EEJ3oe0psyE-LLgTYt6BQy-K9ge1KmCi1B5sr9HEr8zikcDeuAHNeNR4w';
            console.warn('Usando credenciais de fallback');
            resolve({
                supabaseUrl: SUPABASE_URL,
                supabaseAnonKey: SUPABASE_KEY,
                pixApiUrl: DUTTYFY_PIX_URL_ENCRIPTADA
            });
        });
    });
}

// Carregar credenciais ao carregar a página
carregarCredenciais();

// Função para chamar API através do Supabase (proxy CORS) com fallback
function chamarAPIViaSupabase(endpoint, method, data) {
    // Garantir que temos as credenciais antes de fazer a chamada
    if (!SUPABASE_URL || !SUPABASE_KEY) {
        return Promise.reject(new Error('Credenciais não carregadas. Aguarde o carregamento.'));
    }
    
    var url = SUPABASE_URL + '/functions/v1/smooth-endpoint';
    
    console.log('Chamando Supabase Edge Function:', url);
    console.log('Endpoint destino:', endpoint);
    console.log('Method:', method);
    console.log('Data:', data);
    
    // Tentar chamar Supabase primeiro
    // Primeiro tenta sem autenticação (se a função for pública)
    var headers = {
        'Content-Type': 'application/json'
    };
    
    // Adicionar autenticação apenas se SUPABASE_KEY estiver disponível
    // Mas primeiro tenta sem auth para funções públicas
    var fetchOptions = {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
            endpoint: endpoint,
            method: method,
            data: data
        })
    };
    
    // Se SUPABASE_KEY estiver disponível, adicionar headers de auth
    if (SUPABASE_KEY) {
        headers['Authorization'] = 'Bearer ' + SUPABASE_KEY;
        headers['apikey'] = SUPABASE_KEY;
    }
    
    return fetch(url, fetchOptions)
    .then(function(response) {
        console.log('Resposta do Supabase - Status:', response.status);
        console.log('Resposta do Supabase - OK:', response.ok);
        
        // Se retornar erro, tentar parsear o erro primeiro
        if (!response.ok) {
            return response.text().then(function(text) {
                console.error('Erro do Supabase:', text);
                var errorData;
                try {
                    errorData = JSON.parse(text);
                } catch (e) {
                    errorData = { error: text || 'Erro desconhecido' };
                }
                
                // Se for erro 405 ou 404, a função pode não estar deployada
                if (response.status === 405 || response.status === 404) {
                    throw new Error('Supabase Edge Function não encontrada ou não configurada. Status: ' + response.status + '. Verifique se a função smooth-endpoint está deployada.');
                }
                
                // Para outros erros, tentar fallback
                console.warn('Supabase retornou erro ' + response.status + ', usando fallback');
                return chamarAPIViaProxyPublico(endpoint, method, data);
            });
        }
        
        // Se OK, retornar a resposta
        return response;
    })
    .catch(function(error) {
        console.error('Erro ao chamar Supabase:', error);
        
        // Se for erro de rede ou CORS, tentar fallback
        if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('CORS'))) {
            console.warn('Erro de rede/CORS ao chamar Supabase, tentando fallback');
            return chamarAPIViaProxyPublico(endpoint, method, data);
        }
        
        // Se for erro específico da função não encontrada, não tentar fallback
        if (error.message && error.message.includes('Edge Function não encontrada')) {
            throw error; // Propagar o erro para mostrar mensagem específica
        }
        
        // Para outros erros, tentar fallback
        return chamarAPIViaProxyPublico(endpoint, method, data);
    });
}

// Função fallback usando proxy CORS público com múltiplas tentativas
// Versão atualizada: 2026-02-09 - Proxies melhorados
function chamarAPIViaProxyPublico(endpoint, method, data) {
    console.log('Usando proxy CORS público como fallback (v2.0)');
    
    // Lista de proxies CORS alternativos para tentar em sequência
    // Usando proxies mais confiáveis e que suportam POST
    var proxies = [
        {
            url: 'https://api.allorigins.win/raw?url=',
            format: 'encoded'
        },
        {
            url: 'https://corsproxy.io/?',
            format: 'encoded'
        },
        {
            url: 'https://api.codetabs.com/v1/proxy?quest=',
            format: 'encoded'
        }
    ];
    
    var fetchOptions = {
        method: method || 'GET',
        headers: {
            'Content-Type': 'application/json'
        },
        mode: 'cors',
        cache: 'no-cache'
    };
    
    if (data && (method === 'POST' || method === 'PUT')) {
        fetchOptions.body = JSON.stringify(data);
    }
    
    // Função recursiva para tentar cada proxy
    function tentarProxy(index) {
        if (index >= proxies.length) {
            // Se todos os proxies falharam, mostrar erro informativo
            console.error('Todos os proxies CORS falharam');
            var errorMsg = 'Não foi possível conectar à API de pagamento. ';
            errorMsg += 'Isso pode ser devido a restrições de CORS. ';
            errorMsg += 'Por favor, verifique se o Supabase Edge Function está configurado corretamente ou entre em contato com o suporte técnico.';
            throw new Error(errorMsg);
        }
        
        var proxy = proxies[index];
        var finalUrl;
        
        // Formatar URL conforme o tipo de proxy
        if (proxy.format === 'encoded') {
            finalUrl = proxy.url + encodeURIComponent(endpoint);
        } else {
            finalUrl = proxy.url + endpoint;
        }
        
        console.log('Tentando proxy ' + (index + 1) + ' de ' + proxies.length + ':', proxy.url);
        
        return fetch(finalUrl, fetchOptions)
            .then(function(response) {
                console.log('Resposta do proxy ' + (index + 1) + ' - Status:', response.status);
                
                // Verificar se a resposta é válida
                if (!response.ok) {
                    // Se for erro 4xx ou 5xx, tentar próximo proxy
                    throw new Error('Erro HTTP ' + response.status);
                }
                
                // Verificar se a resposta tem conteúdo JSON válido
                var contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response;
                } else {
                    // Se não for JSON, pode ser que o proxy retornou HTML de erro
                    throw new Error('Resposta não é JSON válido');
                }
            })
            .catch(function(error) {
                console.warn('Proxy ' + (index + 1) + ' falhou:', error.message);
                // Tentar próximo proxy
                return tentarProxy(index + 1);
            });
    }
    
    return tentarProxy(0);
}

// Variável para controlar se já existe uma requisição em andamento
var pixRequestInProgress = false;

// Função para gerar PIX
function gerarPIX(formData, cart, total) {
    // CONTROLE DE DUPLICAÇÃO: Verificar se já existe uma requisição em andamento
    if (pixRequestInProgress) {
        console.warn('Requisição PIX já em andamento. Aguarde...');
        return;
    }
    
    // CONTROLE DE DUPLICAÇÃO: Verificar se já existe um transactionId pendente
    var existingTransactionId = localStorage.getItem('transactionId');
    if (existingTransactionId) {
        var confirmar = confirm('Já existe um pagamento PIX em andamento. Deseja continuar com o pagamento anterior ou criar um novo?');
        if (!confirmar) {
            // Redirecionar para página de pagamento existente
            window.location.href = 'pagamento-pix.html';
            return;
        }
        // Se confirmar, limpar o anterior e criar novo
        localStorage.removeItem('pixCode');
        localStorage.removeItem('transactionId');
    }
    
    var btnFinalizar = document.getElementById('btn-finalizar');
    btnFinalizar.disabled = true;
    btnFinalizar.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Gerando PIX...';
    
    // Marcar que uma requisição está em andamento
    pixRequestInProgress = true;
    
    // Aguardar credenciais antes de continuar
    carregarCredenciais().then(function() {
        // Preparar dados para a API
        var cpfLimpo = formData.cpf.replace(/\D/g, '');
        var telefoneLimpo = formData.telefone.replace(/\D/g, '');
        var valorCentavos = Math.round(total * 100); // Converter para centavos
        
        // Pegar o primeiro item do carrinho para o item
        var primeiroItem = cart[0];
        var nomeItem = primeiroItem ? primeiroItem.name : 'Produto';
        var precoItem = primeiroItem ? Math.round(primeiroItem.price * 100) : valorCentavos;
        var quantidadeItem = primeiroItem ? primeiroItem.quantity : 1;
        
        var pixData = {
            amount: valorCentavos,
            description: "Pagamento via Pix - Cacau Show",
            customer: {
                name: formData.nome,
                document: cpfLimpo,
                email: formData.email,
                phone: telefoneLimpo
            },
            item: {
                title: nomeItem,
                price: precoItem,
                quantity: quantidadeItem
            },
            paymentMethod: "PIX"
            // utm é opcional conforme documentação, pode ser adicionado se necessário
            // utm: "utm_source=site&utm_medium=checkout"
        };
        
        // Usar a URL encriptada carregada dinamicamente
        if (!DUTTYFY_PIX_URL_ENCRIPTADA) {
            throw new Error('Credenciais não carregadas. Por favor, recarregue a página.');
        }
        var apiUrl = DUTTYFY_PIX_URL_ENCRIPTADA;
    
        // Aguardar credenciais e chamar API através do Supabase
        // Garantir que as credenciais estão carregadas antes de fazer a chamada
        carregarCredenciais().then(function() {
            if (!DUTTYFY_PIX_URL_ENCRIPTADA) {
                throw new Error('Credenciais não carregadas. Por favor, recarregue a página.');
            }
            
            console.log('Chamando API PIX via Supabase...');
            return chamarAPIViaSupabase(apiUrl, 'POST', pixData);
        })
        .then(function(response) {
            console.log('Resposta recebida:', response);
            
            // Verificar se é uma Response do fetch ou já é um objeto
            if (response instanceof Response) {
                if (!response.ok) {
                    return response.json().then(function(err) {
                        throw new Error(err.error || 'Erro na requisição: ' + response.status);
                    });
                }
                return response.json();
            } else {
                // Já é um objeto JSON
                return Promise.resolve(response);
            }
        })
        .then(function(result) {
            console.log('Resultado processado:', result);
            
            // A resposta do Supabase pode vir dentro de um campo 'data' ou diretamente
            var data = result.data || result;
            btnFinalizar.disabled = false;
            btnFinalizar.innerHTML = '<i class="fa fa-check"></i> Finalizar Pedido';
            
            if (data.error) {
                alert('Erro ao gerar PIX: ' + data.error);
                return;
            }
            
            if (data.pixCode && data.transactionId) {
                // Salvar dados do PIX
                localStorage.setItem('pixCode', data.pixCode);
                localStorage.setItem('transactionId', data.transactionId);
                localStorage.setItem('checkoutData', JSON.stringify(formData));
                
                // Marcar timestamp da transação para controle
                localStorage.setItem('pixTransactionTimestamp', Date.now().toString());
                
                // Liberar flag de requisição em andamento
                pixRequestInProgress = false;
                
                // Redirecionar para página de pagamento PIX
                window.location.href = 'pagamento-pix.html';
            } else {
                // Liberar flag de requisição em andamento
                pixRequestInProgress = false;
                btnFinalizar.disabled = false;
                btnFinalizar.innerHTML = '<i class="fa fa-check"></i> Finalizar Pedido';
                alert('Erro ao gerar código PIX. Por favor, tente novamente.');
            }
        })
        .catch(function(error) {
            // Liberar flag de requisição em andamento em caso de erro
            pixRequestInProgress = false;
            btnFinalizar.disabled = false;
            btnFinalizar.innerHTML = '<i class="fa fa-check"></i> Finalizar Pedido';
            console.error('Erro ao gerar PIX:', error);
            
            // Mensagem de erro mais específica
            var errorMsg = 'Erro ao gerar PIX. ';
            if (error.message) {
                errorMsg += error.message;
            } else {
                errorMsg += 'Por favor, verifique se a Supabase Edge Function está configurada corretamente.';
            }
            alert(errorMsg);
        });
    }).catch(function(error) {
        btnFinalizar.disabled = false;
        btnFinalizar.innerHTML = '<i class="fa fa-check"></i> Finalizar Pedido';
        console.error('Erro ao carregar credenciais:', error);
        alert('Erro ao carregar configurações. Por favor, recarregue a página.');
    });
}

// Validação e envio do formulário
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // CONTROLE DE DUPLICAÇÃO: Verificar se já existe requisição em andamento
    if (pixRequestInProgress) {
        console.warn('Requisição PIX já em andamento. Aguarde...');
        alert('Uma requisição de pagamento já está em andamento. Aguarde...');
        return;
    }
    
    var formData = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        cpf: document.getElementById('cpf').value,
        telefone: document.getElementById('telefone').value,
        cep: document.getElementById('cep').value,
        rua: document.getElementById('rua').value,
        numero: document.getElementById('numero').value,
        complemento: document.getElementById('complemento').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value
    };
    
    // Validar campos obrigatórios
    var requiredFields = ['nome', 'email', 'cpf', 'telefone', 'cep', 'rua', 'numero', 'bairro', 'cidade', 'estado'];
    var isValid = true;
    
    requiredFields.forEach(function(field) {
        var input = document.getElementById(field);
        if (!formData[field] || formData[field].trim() === '') {
            input.classList.add('error');
            isValid = false;
        } else {
            input.classList.remove('error');
        }
    });
    
    if (!isValid) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    // Validar CPF
    var cpfLimpo = formData.cpf.replace(/\D/g, '');
    if (cpfLimpo.length !== 11) {
        document.getElementById('cpf').classList.add('error');
        alert('CPF inválido. Por favor, digite um CPF válido com 11 dígitos.');
        return;
    }
    
    if (!validarCPF(formData.cpf)) {
        document.getElementById('cpf').classList.add('error');
        alert('CPF inválido. Por favor, digite um CPF válido.');
        return;
    }
    
    // Validar telefone
    var telefoneLimpo = formData.telefone.replace(/\D/g, '');
    if (telefoneLimpo.length < 10 || telefoneLimpo.length > 11) {
        document.getElementById('telefone').classList.add('error');
        alert('Telefone inválido. Por favor, digite um telefone válido com DDD.');
        return;
    }
    
    // Verificar se há itens no carrinho
    var cart = JSON.parse(localStorage.getItem('cacaushow_cart') || '[]');
    if (cart.length === 0) {
        alert('Seu carrinho está vazio. Adicione produtos antes de finalizar a compra.');
        window.location.href = 'index.html';
        return;
    }
    
    // Calcular total
    var total = 0;
    cart.forEach(function(item) {
        total += item.price * item.quantity;
    });
    
    if (total < 1) {
        alert('O valor mínimo da compra é R$ 1,00.');
        return;
    }
    
    // Gerar PIX
    gerarPIX(formData, cart, total);
});
</script>

<footer class="footer" id="footercontent">
    <div class="footer__container">
        <div class="footer__header">
            <div class="footer__logo">
                <span class="icon-big_logo"></span>
            </div>
        </div>
        <div class="row footer__main mx-0">
            <div class="footer__internalLinks">
                <div class="content-asset">
                    <ul>
                        <li><a href="https://www.cacaushow.com.br/para-sua-empresa/institucional.html"><span class="icon icon-mini_logo"></span> <span class="footer__text"> Sobre a <b>Cacau Show</b> </span> </a></li>
                        <li><a href="https://www.cacaushow.com.br/fazenda/fazenda.html"><span class="icon"> <img alt="" src="images/footer_tree.svg" title=""> </span> <span class="footer__text"> Nossa <b>Fazenda</b> </span> </a></li>
                        <li><a href="https://www.institutocacaushow.org.br/" target="_blank"><span class="icon"> <img alt="Grupo Cacau Show" src="images/icon-cacau-group.svg" title=""> </span> <span class="footer__text"> <b>Instituto</b> Cacau Show </span> </a></li>
                        <li><a href="https://www.eureciclo.com.br/" target="_blank"><span class="icon"> <img alt="eu reciclo" src="images/icon-eureciclo.svg" style="width: 100px" title=""> </span></a></li>
                        <li><a href="https://www.privacidade.com.br/portal-de-privacidade?token=e8d91724233537d3a44c65424e6b9ee7" target="_blank"><img src="images/selo_portal_de_privacidade.png" style="width: 120px"></a></li>
                    </ul>
                </div>
            </div>
            <div class="footer__privacyTerms">
                <div class="content-asset">
                    <p>Preços apresentados na loja virtual podem variar de acordo com a região. Informações sobre preços, prazos de validade, estoque e origem podem ser obtidas diretamente nas lojas. Consulte a loja para verificar disponibilidade.</p>
                    <p>Preços, estoques, informações e condições disponíveis no site estão sujeitos a alterações sem aviso prévio.</p>
                </div>
            </div>
            <div class="footer__policyLinks">
                <div class="content-asset">
                    <h3>Institucional</h3>
                    <p><a href="https://revendedor.cacaushow.com.br/revendedor/" target="_blank">Seja um Revendedor</a></p>
                    <p><a href="https://www.cacaushow.com.br/franquia.html">Seja um Franqueado</a></p>
                    <p><a href="https://www.cacaushow.com.br/para-sua-empresa/para-sua-empresa.html">Área para Empresas</a></p>
                    <p><a href="https://cacaushow.gupy.io/" target="_blank">Trabalhe Conosco</a></p>
                </div>
            </div>
            <div class="footer__policyLinks">
                <div class="content-asset">
                    <h3>Políticas</h3>
                    <p><a href="https://www.cacaushow.com.br/terms.html">Termos de Uso</a></p>
                    <p><a href="https://www.privacidade.com.br/portal-de-privacidade?token=e8d91724233537d3a44c65424e6b9ee7" target="_blank">Política de Privacidade</a></p>
                    <p><a href="https://www.cacaushow.com.br/politica/returns.html">Política de Trocas</a></p>
                    <p><a href="https://www.cacaushow.com.br/faqs.html">FAQ</a></p>
                </div>
            </div>
            <div class="col footer__wrapper">
                <div class="footer__socialLinks">
                    <div class="content-asset">
                        <ul>
                            <li><span class="social-text">Siga-nos</span></li>
                            <li><a href="https://www.facebook.com/CacauShow" target="_blank" title="Facebook"><span class="icon-social_fb"></span> </a></li>
                            <li><a href="https://www.instagram.com/cacaushow/" target="_blank" title="Instagram"><span class="icon-social_insta"></span> </a></li>
                            <li><a href="https://www.youtube.com/user/CacauShowBR" target="_blank" title="Youtube"><span class="icon-social_yb"></span> </a></li>
                            <li><a href="https://www.tiktok.com/@cacaushow" target="_blank" title="TikTok"><span class="icon-tiktok"></span> </a></li>
                        </ul>
                    </div>
                </div>
                <div class="d-none d-sm-block footer__image">
                    <img src="images/bg_footer-feliz.png" alt="Cacau Show">
                </div>
            </div>
        </div>
    </div>
</footer>

</div>

<script src="js/gretel.min.js" type="text/javascript" async="async"></script>

</body></html>
