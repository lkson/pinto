<!DOCTYPE html><html lang="pt"><head>
<meta charset="UTF-8">

<link rel="preload" href="https://www.googletagmanager.com/gtm.js?id=GTM-PQSFKTS" as="script">
<link rel="preload" href="https://www.googletagmanager.com/gtag/js?id=G-TTZNN90HGX&l=dataLayer&cx=c" as="script">
<link rel="preload" href="https://www.google-analytics.com/analytics.js" as="script">
<link rel="preload" href="https://connect.facebook.net/en_US/fbevents.js" as="script">

<!--[if gt IE 9]><!-->
<script defer="" type="text/javascript" src="js/main.js"></script>
<!--<![endif]-->

<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Checkout - Dados de Envio | Loja Cacau Show</title>

<meta name="description" content="Checkout - Dados de Envio - Loja Cacau Show">
<meta name="keywords" content="Checkout, Envio, Entrega, Cacau Show">

<meta property="og:title" content="Checkout - Dados de Envio | Loja Cacau Show">
<meta property="og:description" content="Checkout - Dados de Envio - Loja Cacau Show">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Cacau Show">
<meta property="og:locale" content="pt_BR">

<link rel="icon" href="images/favicon.ico" sizes="32x32">
<link rel="icon" href="images/favicon.svg" type="image/svg+xml">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PQSFKTS');</script>
<!-- End Google Tag Manager -->

<link rel="stylesheet" href="css/global.css">
<link rel="stylesheet" href="css/detail.css">
<link rel="stylesheet" href="css/backgroundColorLayout.css">
<link rel="stylesheet" href="css/component.css">
<link rel="stylesheet" href="css/productTile.css">
<link rel="stylesheet" href="css/einsteinCarousel.css">
<link rel="stylesheet" href="css/campaignBanner.css">
<link rel="stylesheet" href="css/smartOrderRefill.css">

<style>
.checkout-form {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.checkout-form h2 {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #00A859;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.form-group label .required {
    color: #dc3545;
    margin-left: 3px;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s;
    box-sizing: border-box;
    line-height: 1.5;
    height: auto;
    min-height: auto;
}

/* Garante que select tenha exatamente a mesma altura dos inputs */
select.form-control {
    height: auto !important;
    min-height: auto !important;
    line-height: 1.5 !important;
    padding-top: 12px !important;
    padding-bottom: 12px !important;
}

.form-control:focus {
    outline: none;
    border-color: #00A859;
    box-shadow: 0 0 0 3px rgba(0, 168, 89, 0.1);
}

.form-control.error {
    border-color: #dc3545;
}

/* Corrige o corte de texto no select de estado e garante mesma altura dos outros campos */
select.form-control,
select#estado,
#estado.form-control {
    padding: 12px 40px 12px 15px !important;
    text-indent: 0 !important;
    text-overflow: clip !important;
    overflow: visible !important;
    white-space: nowrap !important;
    word-wrap: normal !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 15px center !important;
    background-size: 12px !important;
    cursor: pointer !important;
    min-width: 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
    line-height: 1.5 !important;
    height: auto !important;
    min-height: auto !important;
    direction: ltr !important;
    text-align: left !important;
    font-size: 14px !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
}

select.form-control option {
    padding: 8px 12px;
    white-space: normal;
}

/* Garante que o texto do select não seja cortado - regra específica e forte */
#estado {
    padding: 12px 40px 12px 15px !important;
    text-indent: 0 !important;
    text-overflow: clip !important;
    overflow: visible !important;
    white-space: nowrap !important;
    direction: ltr !important;
    text-align: left !important;
    height: auto !important;
    min-height: auto !important;
    line-height: 1.5 !important;
}

.cep-search-btn {
    margin-top: 8px;
    padding: 8px 16px;
    background: #0066CC;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
}

.cep-search-btn:hover {
    background: #0052a3;
}

.cep-loading {
    display: none;
    color: #0066CC;
    font-size: 12px;
    margin-top: 5px;
}

.row-form {
    display: flex;
    gap: 15px;
}

.row-form .form-group {
    flex: 1;
}

.btn-checkout {
    width: 100%;
    background: #00A859;
    color: white;
    border: none;
    padding: 16px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
}

.btn-checkout:hover {
    background: #008a47;
}

.btn-checkout:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.btn-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #0066CC;
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 20px;
}

.btn-back:hover {
    text-decoration: underline;
}

/* Regras específicas e fortes para evitar corte de texto no select de estado */
select#estado,
#estado,
select[name="estado"],
.form-group select#estado {
    padding-left: 20px !important;
    padding-right: 45px !important;
    padding-top: 12px !important;
    padding-bottom: 12px !important;
    text-indent: 0 !important;
    text-overflow: clip !important;
    overflow: visible !important;
    white-space: nowrap !important;
    word-wrap: normal !important;
    direction: ltr !important;
    text-align: left !important;
    box-sizing: border-box !important;
    width: 100% !important;
    min-width: 100px !important;
    max-width: 100% !important;
}

/* Força o padding interno do select */
select#estado::-ms-expand {
    display: none;
}

select#estado option {
    padding: 10px 15px !important;
    text-indent: 0 !important;
}

/* Ajustar posicionamento da imagem "feliz hoje" para não cobrir os ícones sociais */
.footer__image {
    margin-top: 5px !important;
}

.footer__image img {
    position: relative;
    top: 3px;
}
</style>

<link rel="stylesheet" href="css/skin.css">

</head><body>

<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PQSFKTS" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<div class="page" data-action="null" data-querystring="null">
<header class="it__header">
    <a href="#maincontent" class="skip" aria-label="Ir para conteúdo principal">Ir para conteúdo principal</a>
    <a href="#footercontent" class="skip" aria-label="Ir para conteúdo do rodapé">Ir para conteúdo do rodapé</a>
    <div class="header-banner slide-up d-none">
        <div class="container">
            <div class="d-flex justify-content-between">
                <div class="content"></div>
                <div class="close-button">
                    <button type="button" class="close" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="header container">
        <div class="it__header--bgContainer">
            <div class="it__header--bg container-wrapper">
                <div class="col p-0">
                    <div class="navbar-header brand">
                        <div class="d-flex flex-row justify-content-between align-items-center">
                            <a class="logo-home" href="index.html" title="Cacau Show Home">
                                <img class="it_header--logo" src="images/logo_cacau_show.svg" alt="Cacau Show">
                            </a>
                            <div class="d-xl-none d-flex align-items-center">
                                <div class="minicart" data-action-url="/on/demandware.store/Sites-CacauShow-Site/pt_BR/Cart-MiniCartShow">
                                    <div class="minicart-total">
                                        <a class="minicart-link" href="carrinho.html" title="carrinho 0 Itens" aria-label="carrinho 0 Itens" aria-haspopup="true">
                                            <i class="minicart-icon fa fa-shopping-bag"></i>
                                            <span class="minicart-quantity">0</span>
                                        </a>
                                    </div>
                                    <div class="popover popover-bottom"></div>
                                </div>
                                <button class="navbar-toggler" type="button" aria-controls="sg-navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                                    <span class="icon-menu"></span>
                                </button>
                                <button class="close-button" type="button" role="button" aria-label="Fechar menu">
                                    Fechar menu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-5">
                    <div class="it__search">
                        <div class="site-search">
                            <form role="search" action="/busca" method="get" name="simpleSearch">
                                <input class="form-control search-field" type="text" name="q" value="" placeholder="Buscar Produto" role="combobox" aria-describedby="search-assistive-text" aria-haspopup="listbox" aria-owns="search-results" aria-expanded="false" aria-autocomplete="list" aria-activedescendant="" aria-controls="search-results" aria-label="Insira palavra chave ou nº do item" autocomplete="off">
                                <button type="reset" name="reset-button" class="reset-button d-none" aria-label="">
                                    <img src="images/icon-x-lg.svg" alt="">
                                </button>
                                <div class="suggestions-wrapper" data-url="/on/demandware.store/Sites-CacauShow-Site/pt_BR/SearchServices-GetSuggestions?q="></div>
                                <input type="hidden" value="null" name="lang">
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-xl-5 it__login">
                    <div class="it__login--options">
                        <div class="user">
                            <a class="btn btn-chamoisee" href="/minha-conta" role="button" aria-label="Entrar na minha conta">
                                <i class="fa fa-sign-in" aria-hidden="true"></i>
                                <span class="user-message">Entrar</span>
                            </a>
                        </div>
                        <div class="it__changeCep">
                            <button class="js-header-postal-code" data-toggle="modal" data-target="#modal-cep">
                                <span class="it__changeCep__address">Cacau Show - SP</span>
                                <span class="it__changeCep__btnChange">Alterar</span>
                            </button>
                        </div>
                    </div>
                    <div class="it__minicart d-none d-xl-block">
                        <div class="minicart" data-action-url="/on/demandware.store/Sites-CacauShow-Site/pt_BR/Cart-MiniCartShow">
                            <div class="minicart-total">
                                <a class="minicart-link" href="carrinho.html" title="carrinho 0 Itens" aria-label="carrinho 0 Itens" aria-haspopup="true">
                                    <i class="minicart-icon fa fa-shopping-bag"></i>
                                    <span class="minicart-quantity">0</span>
                                </a>
                            </div>
                            <div class="popover popover-bottom"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<div role="main" class="null" id="maincontent">
    <div class="storepage" id="checkout">
        <div class="container" style="padding: 40px 15px;">
            <div class="row">
                <div class="col-12">
                    <div class="it_product-detail__name" style="margin-bottom: 40px; padding-top: 20px;">
                        <h1 style="font-size: 28px; font-weight: 600; color: #333; margin: 0;">Dados de Envio</h1>
                    </div>
                    
                    <a href="carrinho.html" class="btn-back">
                        <i class="fa fa-arrow-left"></i>
                        Voltar ao Carrinho
                    </a>

                    <div class="row">
                        <div class="col-lg-8 col-12">
                            <form id="checkout-form" class="checkout-form">
                                <h2>Dados Pessoais</h2>
                                
                                <div class="form-group">
                                    <label for="nome">Nome Completo <span class="required">*</span></label>
                                    <input type="text" id="nome" name="nome" class="form-control" required placeholder="Digite seu nome completo">
                                </div>

                                <div class="row-form">
                                    <div class="form-group">
                                        <label for="email">E-mail <span class="required">*</span></label>
                                        <input type="email" id="email" name="email" class="form-control" required placeholder="seu@email.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="cpf">CPF <span class="required">*</span></label>
                                        <input type="text" id="cpf" name="cpf" class="form-control" required placeholder="000.000.000-00" maxlength="14">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="telefone">Telefone <span class="required">*</span></label>
                                    <input type="tel" id="telefone" name="telefone" class="form-control" required placeholder="(11) 99999-9999" maxlength="15">
                                </div>

                                <h2 style="margin-top: 40px;">Endereço de Entrega</h2>

                                <div class="form-group">
                                    <label for="cep">CEP <span class="required">*</span></label>
                                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                                        <input type="text" id="cep" name="cep" class="form-control" required placeholder="00000-000" maxlength="9" style="flex: 1;">
                                        <button type="button" id="btn-buscar-cep" class="cep-search-btn">
                                            <i class="fa fa-search"></i> Buscar
                                        </button>
                                    </div>
                                    <div id="cep-loading" class="cep-loading">
                                        <i class="fa fa-spinner fa-spin"></i> Buscando endereço...
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="rua">Rua/Logradouro <span class="required">*</span></label>
                                    <input type="text" id="rua" name="rua" class="form-control" required placeholder="Nome da rua">
                                </div>

                                <div class="row-form">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="numero">Número <span class="required">*</span></label>
                                        <input type="text" id="numero" name="numero" class="form-control" required placeholder="123">
                                    </div>
                                    <div class="form-group" style="flex: 3;">
                                        <label for="complemento">Complemento</label>
                                        <input type="text" id="complemento" name="complemento" class="form-control" placeholder="Apto, Bloco, etc.">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="bairro">Bairro <span class="required">*</span></label>
                                    <input type="text" id="bairro" name="bairro" class="form-control" required placeholder="Nome do bairro">
                                </div>

                                <div class="row-form">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="cidade">Cidade <span class="required">*</span></label>
                                        <input type="text" id="cidade" name="cidade" class="form-control" required placeholder="Nome da cidade">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="estado">Estado <span class="required">*</span></label>
                                        <select id="estado" name="estado" class="form-control" required>
                                            <option value="">Selecione</option>
                                            <option value="AC">Acre</option>
                                            <option value="AL">Alagoas</option>
                                            <option value="AP">Amapá</option>
                                            <option value="AM">Amazonas</option>
                                            <option value="BA">Bahia</option>
                                            <option value="CE">Ceará</option>
                                            <option value="DF">Distrito Federal</option>
                                            <option value="ES">Espírito Santo</option>
                                            <option value="GO">Goiás</option>
                                            <option value="MA">Maranhão</option>
                                            <option value="MT">Mato Grosso</option>
                                            <option value="MS">Mato Grosso do Sul</option>
                                            <option value="MG">Minas Gerais</option>
                                            <option value="PA">Pará</option>
                                            <option value="PB">Paraíba</option>
                                            <option value="PR">Paraná</option>
                                            <option value="PE">Pernambuco</option>
                                            <option value="PI">Piauí</option>
                                            <option value="RJ">Rio de Janeiro</option>
                                            <option value="RN">Rio Grande do Norte</option>
                                            <option value="RS">Rio Grande do Sul</option>
                                            <option value="RO">Rondônia</option>
                                            <option value="RR">Roraima</option>
                                            <option value="SC">Santa Catarina</option>
                                            <option value="SP">São Paulo</option>
                                            <option value="SE">Sergipe</option>
                                            <option value="TO">Tocantins</option>
                                        </select>
                                    </div>
                                </div>

                                <button type="submit" class="btn-checkout" id="btn-finalizar">
                                    <i class="fa fa-check"></i>
                                    Finalizar Pedido
                                </button>
                            </form>
                        </div>

                        <div class="col-lg-4 col-12">
                            <div style="position: sticky; top: 20px;">
                                <div style="background: #f8f8f8; padding: 30px; border-radius: 8px; border: 1px solid #e8e8e8;">
                                    <h2 style="font-size: 20px; font-weight: 600; color: #333; margin: 0 0 25px 0; padding-bottom: 15px; border-bottom: 1px solid #ddd;">Resumo do Pedido</h2>
                                    
                                    <div id="checkout-summary">
                                        <p style="color: #666; text-align: center; padding: 20px;">Carregando...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para formatar CEP
function formatCEP(value) {
    value = value.replace(/\D/g, '');
    if (value.length > 5) {
        value = value.substring(0, 5) + '-' + value.substring(5, 8);
    }
    return value;
}

// Função para formatar telefone
function formatTelefone(value) {
    value = value.replace(/\D/g, '');
    if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    } else {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    return value;
}

// Função para formatar CPF
function formatCPF(value) {
    value = value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }
    return value;
}

// Aplicar máscaras
document.getElementById('cep').addEventListener('input', function(e) {
    e.target.value = formatCEP(e.target.value);
});

document.getElementById('telefone').addEventListener('input', function(e) {
    e.target.value = formatTelefone(e.target.value);
});

document.getElementById('cpf').addEventListener('input', function(e) {
    e.target.value = formatCPF(e.target.value);
});

// Função para buscar CEP usando ViaCEP API
function buscarCEP() {
    var cep = document.getElementById('cep').value.replace(/\D/g, '');
    var loadingDiv = document.getElementById('cep-loading');
    var btnBuscar = document.getElementById('btn-buscar-cep');
    
    if (cep.length !== 8) {
        alert('Por favor, digite um CEP válido com 8 dígitos.');
        return;
    }
    
    loadingDiv.style.display = 'block';
    btnBuscar.disabled = true;
    
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            btnBuscar.disabled = false;
            
            if (data.erro) {
                alert('CEP não encontrado. Por favor, verifique e tente novamente.');
                return;
            }
            
            // Preencher campos automaticamente
            document.getElementById('rua').value = data.logradouro || '';
            document.getElementById('bairro').value = data.bairro || '';
            document.getElementById('cidade').value = data.localidade || '';
            document.getElementById('estado').value = data.uf || '';
            
            // Focar no campo número após preencher
            document.getElementById('numero').focus();
        })
        .catch(error => {
            loadingDiv.style.display = 'none';
            btnBuscar.disabled = false;
            alert('Erro ao buscar CEP. Por favor, tente novamente.');
            console.error('Erro:', error);
        });
}

// Event listeners
document.getElementById('btn-buscar-cep').addEventListener('click', buscarCEP);

document.getElementById('cep').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        buscarCEP();
    }
});

// Carregar resumo do carrinho
function loadCartSummary() {
    var cart = JSON.parse(localStorage.getItem('cacaushow_cart') || '[]');
    var summaryDiv = document.getElementById('checkout-summary');
    var total = 0;
    
    if (cart.length === 0) {
        summaryDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Seu carrinho está vazio</p>';
        return;
    }
    
    var html = '<div style="margin-bottom: 20px;">';
    cart.forEach(function(item) {
        var itemTotal = item.price * item.quantity;
        total += itemTotal;
        html += '<div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0;">';
        html += '<div style="flex: 1;">';
        html += '<p style="margin: 0; font-size: 14px; color: #333; font-weight: 500;">' + item.name + '</p>';
        html += '<p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Qtd: ' + item.quantity + '</p>';
        html += '</div>';
        html += '<div style="text-align: right;">';
        html += '<p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">R$ ' + itemTotal.toFixed(2).replace('.', ',') + '</p>';
        html += '</div>';
        html += '</div>';
    });
    html += '</div>';
    
    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
    html += '<span style="font-size: 18px; font-weight: 600; color: #333;">Total:</span>';
    html += '<span style="font-size: 24px; font-weight: bold; color: #00A859;">R$ ' + total.toFixed(2).replace('.', ',') + '</span>';
    html += '</div>';
    html += '</div>';
    
    summaryDiv.innerHTML = html;
}

// Atualizar badge do carrinho
function updateCartBadge() {
    var cart = JSON.parse(localStorage.getItem('cacaushow_cart') || '[]');
    var total = cart.reduce(function(sum, item) { return sum + item.quantity; }, 0);
    var badges = document.querySelectorAll('.minicart-quantity');
    badges.forEach(function(badge) {
        badge.textContent = total;
    });
}

// Carregar resumo ao carregar a página
loadCartSummary();
updateCartBadge();

// Função para validar CPF
function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11) return false;
    
    // Verifica se todos os dígitos são iguais
    if (/^(\d)\1{10}$/.test(cpf)) return false;
    
    // Validação dos dígitos verificadores
    var soma = 0;
    var resto;
    
    for (var i = 1; i <= 9; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    
    soma = 0;
    for (var i = 1; i <= 10; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;
    
    return true;
}

// Configuração do Supabase
var SUPABASE_URL = 'https://xudfilvyvydckranlipn.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1ZGZpbHZ5dnlkY2tyYW5saXBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODY4MDAsImV4cCI6MjA4NjE2MjgwMH0.jDevQSnfm25VYoT3jAIjKRLaxJDlQboGT_rNJoPT9v4';

// Função para chamar API através do Supabase (proxy CORS) com fallback
function chamarAPIViaSupabase(endpoint, method, data) {
    var url = SUPABASE_URL + '/functions/v1/smooth-endpoint';
    
    console.log('Chamando Supabase Edge Function:', url);
    console.log('Endpoint destino:', endpoint);
    console.log('Method:', method);
    console.log('Data:', data);
    
    // Tentar chamar Supabase primeiro
    return fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'apikey': SUPABASE_KEY
        },
        body: JSON.stringify({
            endpoint: endpoint,
            method: method,
            data: data
        })
    })
    .then(response => {
        console.log('Resposta do Supabase - Status:', response.status);
        console.log('Resposta do Supabase - Headers:', response.headers);
        
        // Se retornar 405 (Method Not Allowed) ou qualquer erro, usar fallback
        if (response.status === 405 || !response.ok) {
            console.warn('Supabase retornou erro ' + response.status + ', usando fallback');
            return chamarAPIViaProxyPublico(endpoint, method, data);
        }
        
        return response;
    })
    .catch(error => {
        console.error('Erro ao chamar Supabase, tentando fallback:', error);
        // Fallback: usar proxy CORS público
        return chamarAPIViaProxyPublico(endpoint, method, data);
    });
}

// Função fallback usando proxy CORS público
function chamarAPIViaProxyPublico(endpoint, method, data) {
    console.log('Usando proxy CORS público como fallback');
    
    // Usar corsproxy.org como fallback
    var proxyUrl = 'https://corsproxy.org/?';
    var finalUrl = proxyUrl + encodeURIComponent(endpoint);
    
    var fetchOptions = {
        method: method || 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    };
    
    if (data && (method === 'POST' || method === 'PUT')) {
        fetchOptions.body = JSON.stringify(data);
    }
    
    return fetch(finalUrl, fetchOptions)
        .then(response => {
            console.log('Resposta do proxy público - Status:', response.status);
            if (!response.ok) {
                throw new Error('Erro na requisição: ' + response.status);
            }
            return response;
        })
        .catch(error => {
            console.error('Erro no proxy público:', error);
            throw error;
        });
}

// Função para gerar PIX
function gerarPIX(formData, cart, total) {
    var btnFinalizar = document.getElementById('btn-finalizar');
    btnFinalizar.disabled = true;
    btnFinalizar.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Gerando PIX...';
    
    // Preparar dados para a API
    var cpfLimpo = formData.cpf.replace(/\D/g, '');
    var telefoneLimpo = formData.telefone.replace(/\D/g, '');
    var valorCentavos = Math.round(total * 100); // Converter para centavos
    
    // Pegar o primeiro item do carrinho para o item
    var primeiroItem = cart[0];
    var nomeItem = primeiroItem ? primeiroItem.name : 'Produto';
    var precoItem = primeiroItem ? Math.round(primeiroItem.price * 100) : valorCentavos;
    var quantidadeItem = primeiroItem ? primeiroItem.quantity : 1;
    
    var pixData = {
        amount: valorCentavos,
        description: "Pagamento via Pix - Cacau Show",
        customer: {
            name: formData.nome,
            document: cpfLimpo,
            email: formData.email,
            phone: telefoneLimpo
        },
        item: {
            title: nomeItem,
            price: precoItem,
            quantity: quantidadeItem
        },
        paymentMethod: "PIX"
    };
    
    var apiKey = 'GcUMYUZW7Z4Mhd1SFxv_aV-URlF6u2iUg5L3xcC2j0ZSDfKvwBu5lQ8yBrrB32ccWwpeL83wlDEwZyoxOi1JCA';
    var apiUrl = 'https://app.duttyfy.com.br/api-pix/' + apiKey;
    
    // Chamar API através do Supabase
    chamarAPIViaSupabase(apiUrl, 'POST', pixData)
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Erro na requisição: ' + response.status);
            });
        }
        return response.json();
    })
    .then(result => {
        // A resposta do Supabase pode vir dentro de um campo 'data' ou diretamente
        var data = result.data || result;
        btnFinalizar.disabled = false;
        btnFinalizar.innerHTML = '<i class="fa fa-check"></i> Finalizar Pedido';
        
        if (data.error) {
            alert('Erro ao gerar PIX: ' + data.error);
            return;
        }
        
        if (data.pixCode && data.transactionId) {
            // Salvar dados do PIX
            localStorage.setItem('pixCode', data.pixCode);
            localStorage.setItem('transactionId', data.transactionId);
            localStorage.setItem('checkoutData', JSON.stringify(formData));
            
            // Redirecionar para página de pagamento PIX
            window.location.href = 'pagamento-pix.html';
        } else {
            alert('Erro ao gerar código PIX. Por favor, tente novamente.');
        }
    })
    .catch(error => {
        btnFinalizar.disabled = false;
        btnFinalizar.innerHTML = '<i class="fa fa-check"></i> Finalizar Pedido';
        console.error('Erro ao gerar PIX:', error);
        
        // Se falhar com proxy, informar sobre CORS
        if (error.message && error.message.includes('CORS')) {
            alert('Erro de CORS detectado. A API requer configuração de servidor para funcionar corretamente. Por favor, entre em contato com o suporte técnico.');
        } else {
            alert('Erro ao gerar PIX: ' + error.message + '. Por favor, tente novamente.');
        }
    });
}

// Validação e envio do formulário
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    var formData = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        cpf: document.getElementById('cpf').value,
        telefone: document.getElementById('telefone').value,
        cep: document.getElementById('cep').value,
        rua: document.getElementById('rua').value,
        numero: document.getElementById('numero').value,
        complemento: document.getElementById('complemento').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value
    };
    
    // Validar campos obrigatórios
    var requiredFields = ['nome', 'email', 'cpf', 'telefone', 'cep', 'rua', 'numero', 'bairro', 'cidade', 'estado'];
    var isValid = true;
    
    requiredFields.forEach(function(field) {
        var input = document.getElementById(field);
        if (!formData[field] || formData[field].trim() === '') {
            input.classList.add('error');
            isValid = false;
        } else {
            input.classList.remove('error');
        }
    });
    
    if (!isValid) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    // Validar CPF
    var cpfLimpo = formData.cpf.replace(/\D/g, '');
    if (cpfLimpo.length !== 11) {
        document.getElementById('cpf').classList.add('error');
        alert('CPF inválido. Por favor, digite um CPF válido com 11 dígitos.');
        return;
    }
    
    if (!validarCPF(formData.cpf)) {
        document.getElementById('cpf').classList.add('error');
        alert('CPF inválido. Por favor, digite um CPF válido.');
        return;
    }
    
    // Validar telefone
    var telefoneLimpo = formData.telefone.replace(/\D/g, '');
    if (telefoneLimpo.length < 10 || telefoneLimpo.length > 11) {
        document.getElementById('telefone').classList.add('error');
        alert('Telefone inválido. Por favor, digite um telefone válido com DDD.');
        return;
    }
    
    // Verificar se há itens no carrinho
    var cart = JSON.parse(localStorage.getItem('cacaushow_cart') || '[]');
    if (cart.length === 0) {
        alert('Seu carrinho está vazio. Adicione produtos antes de finalizar a compra.');
        window.location.href = 'index.html';
        return;
    }
    
    // Calcular total
    var total = 0;
    cart.forEach(function(item) {
        total += item.price * item.quantity;
    });
    
    if (total < 1) {
        alert('O valor mínimo da compra é R$ 1,00.');
        return;
    }
    
    // Gerar PIX
    gerarPIX(formData, cart, total);
});
</script>

<footer class="footer" id="footercontent">
    <div class="footer__container">
        <div class="footer__header">
            <div class="footer__logo">
                <span class="icon-big_logo"></span>
            </div>
        </div>
        <div class="row footer__main mx-0">
            <div class="footer__internalLinks">
                <div class="content-asset">
                    <ul>
                        <li><a href="https://www.cacaushow.com.br/para-sua-empresa/institucional.html"><span class="icon icon-mini_logo"></span> <span class="footer__text"> Sobre a <b>Cacau Show</b> </span> </a></li>
                        <li><a href="https://www.cacaushow.com.br/fazenda/fazenda.html"><span class="icon"> <img alt="" src="images/footer_tree.svg" title=""> </span> <span class="footer__text"> Nossa <b>Fazenda</b> </span> </a></li>
                        <li><a href="https://www.institutocacaushow.org.br/" target="_blank"><span class="icon"> <img alt="Grupo Cacau Show" src="images/icon-cacau-group.svg" title=""> </span> <span class="footer__text"> <b>Instituto</b> Cacau Show </span> </a></li>
                        <li><a href="https://www.eureciclo.com.br/" target="_blank"><span class="icon"> <img alt="eu reciclo" src="images/icon-eureciclo.svg" style="width: 100px" title=""> </span></a></li>
                        <li><a href="https://www.privacidade.com.br/portal-de-privacidade?token=e8d91724233537d3a44c65424e6b9ee7" target="_blank"><img src="images/selo_portal_de_privacidade.png" style="width: 120px"></a></li>
                    </ul>
                </div>
            </div>
            <div class="footer__privacyTerms">
                <div class="content-asset">
                    <p>Preços apresentados na loja virtual podem variar de acordo com a região. Informações sobre preços, prazos de validade, estoque e origem podem ser obtidas diretamente nas lojas. Consulte a loja para verificar disponibilidade.</p>
                    <p>Preços, estoques, informações e condições disponíveis no site estão sujeitos a alterações sem aviso prévio.</p>
                </div>
            </div>
            <div class="footer__policyLinks">
                <div class="content-asset">
                    <h3>Institucional</h3>
                    <p><a href="https://revendedor.cacaushow.com.br/revendedor/" target="_blank">Seja um Revendedor</a></p>
                    <p><a href="https://www.cacaushow.com.br/franquia.html">Seja um Franqueado</a></p>
                    <p><a href="https://www.cacaushow.com.br/para-sua-empresa/para-sua-empresa.html">Área para Empresas</a></p>
                    <p><a href="https://cacaushow.gupy.io/" target="_blank">Trabalhe Conosco</a></p>
                </div>
            </div>
            <div class="footer__policyLinks">
                <div class="content-asset">
                    <h3>Políticas</h3>
                    <p><a href="https://www.cacaushow.com.br/terms.html">Termos de Uso</a></p>
                    <p><a href="https://www.privacidade.com.br/portal-de-privacidade?token=e8d91724233537d3a44c65424e6b9ee7" target="_blank">Política de Privacidade</a></p>
                    <p><a href="https://www.cacaushow.com.br/politica/returns.html">Política de Trocas</a></p>
                    <p><a href="https://www.cacaushow.com.br/faqs.html">FAQ</a></p>
                </div>
            </div>
            <div class="col footer__wrapper">
                <div class="footer__socialLinks">
                    <div class="content-asset">
                        <ul>
                            <li><span class="social-text">Siga-nos</span></li>
                            <li><a href="https://www.facebook.com/CacauShow" target="_blank" title="Facebook"><span class="icon-social_fb"></span> </a></li>
                            <li><a href="https://www.instagram.com/cacaushow/" target="_blank" title="Instagram"><span class="icon-social_insta"></span> </a></li>
                            <li><a href="https://www.youtube.com/user/CacauShowBR" target="_blank" title="Youtube"><span class="icon-social_yb"></span> </a></li>
                            <li><a href="https://www.tiktok.com/@cacaushow" target="_blank" title="TikTok"><span class="icon-tiktok"></span> </a></li>
                        </ul>
                    </div>
                </div>
                <div class="d-none d-sm-block footer__image">
                    <img src="images/bg_footer-feliz.png" alt="Cacau Show">
                </div>
            </div>
        </div>
    </div>
</footer>

</div>

<script type="text/javascript" src="js/dwanalytics-22.2.js" async="async"></script>
<script src="js/dwac-21.7.js" type="text/javascript" async="async"></script>
<script src="js/gretel.min.js" type="text/javascript" async="async"></script>

</body></html>
